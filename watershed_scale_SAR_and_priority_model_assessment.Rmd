---
title: "Watershed-scale Analysis of SAR and High-Priority Waterbodies"
author: "Chris Madsen and John Phelan"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
  pdf_document: default
editor_options:
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.width = 10, fig.height = 8)
library(tidyverse)
library(sf) # shapes
library(viridis) # colors
library(bcdata)
library(bcmaps)
library(raster)
library(geodata)
library(dismo) # getting the climate models and other cool things
library(ggpattern) # hatching ggplot
library(RColorBrewer) # colors
library(ggspatial) # scale bar
library(patchwork) # For combining ggplot figures in cool ways
library(leaflet)
library(gdalUtilities)

path_to_user = str_extract(getwd(), ".*Users/[A-Z]+")
onedrive_path = paste0(path_to_user,"/OneDrive - Government of BC/data/CNF/")

redo_downstream = FALSE
```

Background: This assessment uses the high-priority waterbodies as defined by the Zebra-Quagga Mussel Prioritization Model (2024 edition), DFO SARA-listed species occurrence data and critical habitat data, and BC Data Catalogue SPI data for Sockeye Salmon to assess overlap between 5 species (4 SARA-listed species and Sockeye Salmon) and the high-priority waterbodies. More detail below.

## Data 
```{r reading_in_data}
# Zebra Quagga Prioritization Model

zqpm <-read_sf(paste0(onedrive_path,"waterbodies_zqm_shortlist_risk_estimates.gpkg"))

# Watersheds of some scale
if(!file.exists(paste0(onedrive_path,'watershed_groups.gpkg'))){
  ws = bcdc_query_geodata('freshwater-atlas-watershed-groups') %>%   
    # This one has 246 rows
    collect()
  # Simplify the geometry! Woo
  ws_s = rmapshaper::ms_simplify(ws)
  sf::write_sf(ws_s,paste0(onedrive_path,'watershed_groups.gpkg'))
} else {
  ws = sf::read_sf(paste0(onedrive_path,'watershed_groups.gpkg'))
}

# Regions (just in case)
regs = bcmaps::nr_regions()

if(!file.exists(paste0(onedrive_path,"dfo_sara_and_crit_hab_and_sockeye_data.gpkg"))){
  # DFO SARA spatial data.
  sara = read_sf(paste0(onedrive_path,"dfo_occurrences_in_BC_all_species.gpkg"))
  
  # Filter SARA occurrence data by scientific name AND population, in one fell swoop.
  sara = sara |> 
    dplyr::filter(Scientific_Name == "Cottus aleuticus" & str_detect(Population_EN, 'Cultus') |
                    Scientific_Name == "Oncorhynchus clarkii lewisi" & str_detect(Population_EN,'Pacific') | 
                    Scientific_Name == "Salvelinus confluentus" & str_detect(Population_EN,'South Coast') | 
                    Scientific_Name == "Gonidea angulata")
  
  # sara |> st_drop_geometry() |> count(Scientific_Name, Population_EN)
  
  sockeye = bcinvadeR::grab_aq_occ_data('sockeye salmon')
  
  # Ensure the geometry column has the right name!
  sockeye = sockeye |> rename(geom = geometry)
  
  # Filter Sockeye for just Cultus lake.
  cultus = bcdc_query_geodata('freshwater-atlas-lakes') |> 
    filter(GNIS_NAME_1 == 'Cultus Lake') |> 
    collect() |> 
    sf::st_transform(st_crs(sockeye))
  
  sockeye = sockeye |> 
    sf::st_filter(cultus)
  
  # Merge sockeye with SARA
  occdat = sara |> 
    dplyr::bind_rows(
      sockeye |> 
        dplyr::mutate(Population_EN = 'Cultus',
                      Common_Name_EN = 'Sockeye Salmon',
                      Scientific_Name = 'Oncorhynchus nerka',
                      Taxon = 'Fishes') |> 
        dplyr::select(Population_EN, Common_Name_EN, Scientific_Name, Taxon) |> 
        sf::st_transform(3857)
    )
  
  ### Critical habitat
  critHab<-read_sf(paste0(onedrive_path,"federal_critical_habitat.gpkg"))
  
  # Make sure column names are the same between critical habitat and SARA occ object.
  ensure_multipolygons <- function(X) {
    tmp1 <- tempfile(fileext = ".gpkg")
    tmp2 <- tempfile(fileext = ".gpkg")
    st_write(X, tmp1)
    ogr2ogr(tmp1, tmp2, f = "GPKG", nlt = "MULTIPOLYGON")
    Y <- st_read(tmp2)
    st_sf(st_drop_geometry(X), geom = st_geometry(Y))
  }
  
  critHabFixed<-ensure_multipolygons(critHab)
  
  critHab_sciFilt<-critHabFixed %>% 
    dplyr::filter(Scientific_Name == "Cottus aleuticus" & str_detect(Population_EN, 'Cultus') |
                    Scientific_Name == "Oncorhynchus clarkii lewisi" & str_detect(Population_EN,'Pacific') | 
                    Scientific_Name == "Salvelinus confluentus" & str_detect(Population_EN,'South Coast') | 
                    Scientific_Name == "Gonidea angulata")
  #unique(critHab$Common_Name_EN)
  
  # critHabTrans<-st_transform(critHab_sciFilt, st_crs(occdat))
  mergedPopn<-bind_rows(occdat, critHab_sciFilt)
  
  # Do st_difference with bc polygon.
  mergedPopn = ensure_multipolygons(mergedPopn)
  
  mergedPopn = sf::st_make_valid(mergedPopn)
  
  mergedPopn_d = sf::st_difference(mergedPopn, bcmaps::bc_bound() |> dplyr::summarise() |> sf::st_transform(3857))
  
  #ggplot() + geom_sf(data = mergedPopn)
  
  sf::write_sf(mergedPopn, paste0(onedrive_path,"dfo_sara_and_crit_hab_and_sockeye_data.gpkg"))
} else {
  mergedPopn = read_sf(paste0(onedrive_path,"dfo_sara_and_crit_hab_and_sockeye_data.gpkg"))
}
```

### DFO and Sockeye Data Summary
```{r dfo_and_sockeye_data_summary}
mergedPopn |> 
  sf::st_drop_geometry() |> 
  # dplyr::select(Common_Name_EN, Scientific_Name, Population_EN) |> 
  dplyr::count(Common_Name_EN, Scientific_Name, Population_EN, name = 'Occurrences') |> 
  knitr::kable()
```

### Zebra-Quagga Mussel Prioritization Model Waterbodies

```{r filter_destination_waterbodies_and_find_downstream_networks_for_each}
#sub water shed scale ws 
#subset the waterbodies zqpm
# slice the first 20
# find which subwatershed these are in
# count of the sensitive species

# zqpm %>% 
#   mutate(across(c("Marinas","TotalInspections","Sum.of.days.fished"),
#                 \(x) as.numeric(cut(x,3)))) %>% 
#   dplyr::select(Marinas,TotalInspections,Sum.of.days.fished)

# zqpm %>%  mutate(Marinas_B = as.numeric(cut(Marinas, 3))) %>% 
#   dplyr::select(Marinas, Marinas_B)
# zqpm$Marinas_B <- zqpm %>% mutate(Marinas_B = as.numeric(cut(Marinas, 3))) %>% 
#   dplyr::select(Marinas, Marinas_B)

# zqpm %>%  mutate(Sum.of.days.fished_B = as.numeric(cut(Sum.of.days.fished, 3))) %>% 
#   dplyr::select(sum.days.fished, sum.days.fished_B)

zqpmUseFilt<-zqpm %>% arrange(desc(InvasionRisk)) %>% 
  dplyr::select(WATERSH, WATERBO, GNIS_NA, InvasionRisk) %>% 
  filter(!GNIS_NA %in% c("Dry Storage", "Pacific Ocean")) #%>%
  # Added Culus Lake by WATERBO as the name included a lake outside Kamloops
  # filter(InvasionRisk >= 3  | WATERBO == 329083342) 
  

# ws_high_priority<-st_filter(ws, zqpmUseFilt)

# We can first identify which subwatershed each SAR polygons is in;
# some will be in multiple subwatersheds. A problem? Maybe.
# ws = st_simplify(ws)

# Alternate methodology: find downstream networks of streams/rivers 
# for each high-priority waterbody; run the overlap with the subwatersheds
# using these networks rather than the waterbody geometry itself.

# if(!file.exists(paste0(onedrive_path,"downstream_geoms.Rds")) | redo_downstream){
#   ######### remove the -1 to include Columbia River and delete the file downstream_geoms
#   #############################################################################################
#   #############################################################################################
#   
#   stream_info = zqpmUseFilt |> 
#     dplyr::filter(!GNIS_NA %in% c("Fraser River","Columbia River")) |> 
#     dplyr::select(GNIS_NA, WATERBO, WATERSH)
#   
#   downstream_geometries = as.list(rep(NA,nrow(stream_info)))
#   
#   for(i in 1:nrow(stream_info)){
#   # for(i in 15:16){
#       
#     print(i)
#     
#     if(is.null(names(downstream_geometries[[i]])[1])){
#       
#       wb_name = stream_info[i,]$GNIS_NA
#       wb_WATERBO = stream_info[i,]$WATERBO
#       wb_WATERSH = stream_info[i,]$WATERSH
#       
#       # Step 1. Use the IMDP inspection data which highlights certain parts
#       # of rivers and lakes based on boat traffic.
#       if(!str_detect(wb_name,'(Lake|Lac)')){
#         result = bcdc_query_geodata('freshwater-atlas-stream-network') %>%
#           bcdata::filter(GNIS_NAME == wb_name,
#                          WATERSHED_GROUP_ID == wb_WATERSH,
#                          WATERBODY_KEY == wb_WATERBO) %>%
#           collect()
#       } else {
#         result = bcdc_query_geodata('freshwater-atlas-lakes') %>%
#           bcdata::filter(GNIS_NAME_1 == wb_name,
#                          WATERSHED_GROUP_ID == wb_WATERSH,
#                          WATERBODY_KEY == wb_WATERBO) %>%
#           collect()
#         
#       }
#       
#       the_fwa_code = unique(result$FWA_WATERSHED_CODE)
#       
#       # ggplot() + geom_sf(data = result)
#       
#       the_entire_river = bcdc_query_geodata('freshwater-atlas-stream-network') %>%
#         bcdata::filter(FWA_WATERSHED_CODE == the_fwa_code) %>%
#         collect()
#       
#       # Find the downstream part of
#       library(fwa.connect)
#       dsn = suppressMessages(fwa.connect::trace_course_downstream(fwa_code = the_fwa_code,
#                                                                   make_plot = T,
#                                                                   add_map_insert = T,
#                                                                   merge_by_BLK = F))
#       
#       fwa_for_search = c(unique(dsn$downstream_course$FWA_WATERSHED_CODE))
#       
#       # Due to a little bug in the package, for now we should requery the bcdata
#       # catalogue one more time to get the full geometries of the downstream network.
#       # It looks like lakes were being excluded? Not sure.
#       dsn_2 = bcdc_query_geodata('freshwater-atlas-stream-network') %>%
#         bcdata::filter(FWA_WATERSHED_CODE %in% fwa_for_search) %>%
#         collect() %>%
#         sf::st_zm() %>% # Drop height dimension from linestring geometries; otherwise it gums up the next few functions.
#         dplyr::group_by(FWA_WATERSHED_CODE, GNIS_NAME) %>%
#         dplyr::summarise() %>%
#         ungroup()
#       
#       dsn_summarised = dsn_2 %>%
#         dplyr::summarise(wb_name = wb_name)
#       
#       downstream_geometries[[i]] = dsn_summarised
#     }
#   }
#   
#   saveRDS(downstream_geometries,paste0(onedrive_path,"downstream_geoms.Rds"))
# }else{
#   downstream_geometries<-readRDS(paste0(onedrive_path,"downstream_geoms.Rds"))
# }

# Combine the list of downstream geometries into a single table.
# ds_geom_bound = dplyr::bind_rows(downstream_geometries)

# We could summarize these networks yet again to get a simple 
# overlap with the subwatersheds. 
# ds_geom_sum = dplyr::summarise(ds_geom_bound)

# Find all subwatersheds that overlap with any of these downstream networks.
# ws_high_priority = ws %>% 
#   sf::st_filter(ds_geom_sum)

# ggplot() + 
#   geom_sf(data = ws_high_priority) + 
#   geom_sf(data = ds_geom_sum, col = 'red')
# ggplot() + geom_sf(data = dsn_2, aes(fill = FWA_WATERSHED_CODE,
#                                      col = FWA_WATERSHED_CODE)) +
#   theme(legend.position = 'none')

# Summarise the SARA-listed, Whirling-Disease-sensitive fish species by subwatershed.


sara_by_wb = mergedPopn %>%
  st_transform(3005) %>% 
  st_simplify() %>% 
  st_join(zqpmUseFilt %>% dplyr::select(GNIS_NA)) %>% 
  sf::st_drop_geometry() %>% 
  dplyr::select(Scientific_Name,Common_Name_EN,GNIS_NA)

sara_by_wb = sara_by_wb %>%
  dplyr::filter(!is.na(GNIS_NA)) |> 
  dplyr::distinct() %>% 
  dplyr::add_count(GNIS_NA, name = 'number_distinct_SAR') |> 
  dplyr::group_by(GNIS_NA,number_distinct_SAR) |> 
  dplyr::summarise(SARA_species = paste0(Common_Name_EN, collapse = ', ')) 

zqpmUseFilt = zqpmUseFilt %>% 
  dplyr::left_join(sara_by_wb) |> 
  dplyr::mutate(number_distinct_SAR = replace_na(number_distinct_SAR, 0),
                SARA_species = replace_na(SARA_species, 'None'))
  
# Maybe to change here: drop bin 2 priority waterbodies
# if they do not overlap with the species-at-risk data.
zqpmUseFilt = zqpmUseFilt |> 
  dplyr::filter(number_distinct_SAR > 0)

#streams - get some SAR and crosschecck with Use
# ws_Sar<-ws[!is.na(ws$number_distinct_SAR),]
# ws_Sar<-ws_Sar[ws_Sar$WATERSHED_GROUP_NAME %in% ws_high_priority$WATERSHED_GROUP_NAME,]

#get overlap for rivers with sar 
# zqpm_Overlap<-zqpmUseFilt[zqpmUseFilt$WATERSH %in% ws_Sar$WATERSHED_GROUP_ID,]
# zqpm_Overlap<-zqpmUseFilt[zqpmUseFilt$WATERSH %in% ws_Sar$WATERSHED_GROUP_ID,]

# zqpm_Overlap<-st_intersection(st_transform(ds_geom_sum, 3005), ws_Sar)

#used watersheds and sar
# ws_high_priority_Overlap<-ws_high_priority[ws_high_priority$WATERSHED_GROUP_ID %in%
                         # ws_Sar$WATERSHED_GROUP_ID,]

# Use suppressMessages just in case the bcmaps package is feeling chatty.
bc <- suppressMessages(bc_bound())

# Make a subset of the subwatershed layer: just those subwatersheds in the window of the high-priority waterbodies and their downstream networks.
# ws_background = sf::st_crop(ws, ws_high_priority)

```

The shortlist of priority waterbodies consists of `r nrow(zqpm)` waterbodies. `r nrow(zqpmUseFilt)` of these waterbodies overlapped with at least one of the target species.

```{r}
DT::datatable(
  zqpm |> 
  sf::st_drop_geometry() |> 
  dplyr::select(GNIS_NA, InvasionRisk)
)
```

```{r downstream_network_overlap}
# # Do a relatively simple overlap with the downstream geometries split by major draining river.
# ds_by_dr_riv = ds_geom_bound |> 
#   mutate(draining_river = str_extract(FWA_WATERSHED_CODE,'^[0-9]{3}')) |> 
#   dplyr::group_by(draining_river) |> 
#   dplyr::summarise()
# 
# sara_by_dr_river_w_geom = mergedPopn %>%
#   st_transform(3005) %>% 
#   st_join(ds_by_dr_riv) %>% 
#   dplyr::filter(!is.na(draining_river))
#   # sf::st_drop_geometry() %>% 
#   # dplyr::select(Common_Name_EN,draining_river)

# sara_by_dr_river = sara_by_dr_river_w_geom %>%
#   sf::st_drop_geometry() |> 
#   dplyr::select(Common_Name_EN,draining_river) |> 
#   dplyr::filter(!is.na(draining_river)) |> 
#   dplyr::distinct() %>% 
#   dplyr::add_count(draining_river, name = 'number_distinct_SAR') |> 
#   dplyr::group_by(draining_river,number_distinct_SAR) |> 
#   dplyr::summarise(SARA_species = paste0(Common_Name_EN, collapse = ', ')) |> 
#   dplyr::ungroup()
```

### Figures {.tabset}

#### High-Priority Waterbodies from ZQM Model
```{r high_Priority_waterbodies_by_Subwatershed}

# Combine the waterbodies flagged as high risk by the ZQ Mussel Prioritization Model with the downstream sections we found above; this allows us to plot a single sf object to the plot below and utilize a legend to easily explain what is what.

priority_wb_and_ds = dplyr::bind_rows(
  # ds_geom_sum |> 
  #   dplyr::rename(geom = geometry) |> 
  #   dplyr::mutate(type = "Downstream\nNetwork"),
  zqpm |> 
    dplyr::mutate(type = "High-priority\nWaterbody")
) |> 
  arrange(type)

# make map insert of BC with region highlighted.
map_inset = ggplot() + 
  geom_sf(data = bc) + 
  # geom_sf(data = dplyr::summarise(ws_high_priority), fill = 'purple') +
  geom_sf(data = priority_wb_and_ds, col = 'red') +
  ggthemes::theme_map() + 
  theme(plot.background = element_rect(color = 'black'))

main_map = ggplot() +
  geom_sf(data = bc) +
  # geom_sf(data = ws_background, fill = "lightgrey")+ # simplify geom?
  # geom_sf(data=ws_high_priority, fill = "purple", color = "black", alpha = 0.3)+
  # geom_sf(data=ds_geom_sum, fill = "orange", color="orange")+
  # geom_sf(data=zqpmUseFilt, fill = "red", color="darkred")+
  geom_sf(data = priority_wb_and_ds,aes(fill = type, col = type)) +
  scale_fill_manual(values = c("Downstream\nNetwork" = "orange",
                               "High-priority\nWaterbody" = "red")) +
  scale_colour_manual(values = c("Downstream\nNetwork" = "orange",
                               "High-priority\nWaterbody" = "red")) +
  labs(title = paste0("High Priority Waterbodies (N = ",nrow(zqpm),")"),
       # subtitle = paste0("This includes downstream networks. \nTotal number of subwatersheds: ",nrow(ws_high_priority)),
       fill = "Waterbody\nType",
       colour = "Waterbody\nType")+
  ggthemes::theme_map()+
  theme(plot.title = element_text(size = rel(3), face = "bold"),
        plot.subtitle = element_text(size = rel(2)),
        legend.title = element_text(size = rel(1.8)),
        legend.text = element_text(size = rel(1.2)),
        legend.position = 'right'
  ) + 
  coord_sf(xlim = sf::st_bbox(priority_wb_and_ds)[c(1,3)],
           ylim = sf::st_bbox(priority_wb_and_ds)[c(2,4)]) + 
  ggspatial::annotation_scale()

# The following code to combine plots uses the {patchwork} package.
if(!interactive()) {
  main_map + patchwork::inset_element(map_inset, right = 1, top = 1, left = 0.8, bottom = 0.75)
}
```

#### Overlapping Target Species and Priority Waterbodies
```{r number_of_distinct_SAR_species_by_Subwatershed}
#sp_colors<-c( "#EFFDB1ff","#BDD793ff","#8BB174ff","#598B56ff","#276537ff")
cols<-c("#007bff", "#ff7f00", "#228b22")
#cols<-col_ramp(4)

g = ggplot() + 
  geom_sf(data = bc, alpha = 0.25) +
  geom_sf(data = priority_wb_and_ds, col = 'grey') +
  geom_sf(data = zqpmUseFilt, 
          aes(fill = SARA_species,
              colour = SARA_species), lwd = 1.8) + 
  scale_fill_manual(values =  cols, na.value = "grey")+
  scale_colour_manual(values =  cols, na.value = "grey")+
  labs(title = 'Number of Distinct SARA-listed Species by Priority Waterbody',
       fill = "Species Common Name",
       colour =  "Species Common Name") +
  # ggthemes::theme_map()+
  theme(plot.title = element_text(size = rel(2), face = "bold"),
        plot.subtitle = element_text(size = rel(1.8)),
        legend.title = element_text(size = rel(1.8)),
        legend.text = element_text(size = rel(1.2)),
        panel.background = element_blank()
        ) +
  coord_sf(xlim = sf::st_bbox(priority_wb_and_ds)[c(1,3)],
           ylim = sf::st_bbox(priority_wb_and_ds)[c(2,4)]) + 
  ggspatial::annotation_scale()


if(!interactive()) {
  print(g)
}

```

### Results as Table
```{r}
## Waterbody by species
DT::datatable(
  zqpmUseFilt |>
    sf::st_drop_geometry() |>
    dplyr::select(-WATERSH, -WATERBO) |>
    dplyr::mutate(number_distinct_SAR = replace_na(number_distinct_SAR, 0)) |>
    dplyr::mutate(SARA_species = replace_na(SARA_species, "None")),
    options = list(
            columnDefs = list(list(className = 'dt-center', targets = 0:4))
            )
)
```

```{r}
### Interactive Map
# zqpm_wgs = sf::st_transform(zqpmUseFilt, 4326)
# 
# my_pal = leaflet::colorFactor(
#   palette = 'PRGn',
#   domain = as.factor(unique(zqpm_wgs$number_distinct_SAR))
# )
# 
# my_pal_l = leaflet::colorFactor(
#   palette = 'PRGn',
#   domain =  as.factor(unique(zqpm_wgs$number_distinct_SAR)),
#   reverse = T
# )
# 
# # Set colours manually
# zqpm_wgs = zqpm_wgs |> 
#   mutate(leaf_col = case_when(
#     number_distinct_SAR == 0 ~ 0,
#     number_distinct_SAR > 0 ~ 0.75
#   ))
# 
# my_tbls = leafpop::popupTable(
#   zqpmUseFilt |> 
#     sf::st_drop_geometry() |> 
#     dplyr::select(-WATERSH,-WATERBO)
#   )
# 
# leaflet(height = 600) |> 
#   addTiles() |> 
#   addProviderTiles(providers$Esri.OceanBasemap) |> 
#   addProviderTiles(providers$CartoDB) |> 
#   addPolylines(
#     data = zqpm_wgs,
#     label = ~paste0(GNIS_NA,": ",number_distinct_SAR),
#     popup = lapply(my_tbls, htmltools::HTML),
#     color = ~my_pal(number_distinct_SAR),
#     opacity = ~leaf_col
#   ) |> 
#   addLegend(
#     title = "Number of<br>Distinct SARA",
#     pal = my_pal_l,
#     values = unique(zqpm_wgs$number_distinct_SAR),
#     labFormat = labelFormat(transform = function(x) sort(x, decreasing = TRUE))
#   ) |> 
#   addScaleBar(position = 'bottomright')
```


```{r downstream_plot}
## Downstream Network Overlaps

# fras = sf::read_sf("W:/CMadsen/shared_data_sets/fraser_watershed_priority_area.gpkg") |>
# dplyr::summarise()
# 
# columbia = sf::read_sf("W:/CMadsen/shared_data_sets/columbia_watershed_priority_area.gpkg") |>
# dplyr::summarise()
# 
# big_boys = dplyr::bind_rows(fras, columbia)
# 
#  ds_limits = sf::st_bbox(st_transform(ds_by_dr_riv,4326))
# 
#  ggplot() +
#    geom_sf(data = big_boys) +
#    geom_sf(data = ds_by_dr_riv) +
#    geom_sf(data = sara_by_dr_river_w_geom, aes(col = Common_Name_EN, fill = Common_Name_EN)) +
#    coord_sf(xlim = ds_limits[c(1,3)],
#             ylim = ds_limits[c(2,4)]) +
#    labs(fill = 'SARA-listed species',
#         col = 'SARA-listed species')
# 
#  sara_by_dr_river |>
#    mutate(draining_river = case_when(
#      draining_river == '100' ~ "Fraser River",
#      draining_river == '300' ~ "Columbia River",
#      T ~ draining_river
#    )) |>
#    sf::st_drop_geometry() |>
#    knitr::kable()
```

```{r}

### SARA species overlap by downstream networks

# all_sara_matched = c("Westslope Cutthroat Trout", "Green Sturgeon", "Mountain Sucker","White Sturgeon","Shorthead Sculpin","Columbia Sculpin","Rocky Mountain Sculpin")
# 
# fras = sf::read_sf(paste0(onedrive_path,"fraser_watershed_priority_area.gpkg")) |>
# dplyr::summarise()
# 
# columbia = sf::read_sf(paste0(onedrive_path,"columbia_watershed_priority_area.gpkg")) |>
# dplyr::summarise()
# 
# # cultus<-zqpm %>% arrange(desc(InvasionRisk)) %>% 
# #   dplyr::select(WATERSH, WATERBO, GNIS_NA, InvasionRisk) %>% 
# #   filter(WATERBO == 329083342) %>% 
# #   dplyr::select(-WATERSH, -WATERBO, -GNIS_NA, -InvasionRisk) %>% 
# #   st_transform(4326)
# 
# big_boys = dplyr::bind_rows(fras, columbia)
# #big_boys<-bind_rows(big_boys, cultus)
# 
# ds_limits = sf::st_bbox(st_transform(ds_by_dr_riv,4326))
# 
#  ggplot() +
#    geom_sf(data = big_boys) +
#    geom_sf(data = ds_by_dr_riv) +
#    geom_sf(data = sara_by_dr_river_w_geom, aes(col = Common_Name_EN, fill = Common_Name_EN)) +
#    coord_sf(xlim = ds_limits[c(1,3)],
#             ylim = ds_limits[c(2,4)]) +
#    labs(fill = 'SARA-listed species',
#         col = 'SARA-listed species')
# 
#  sara_by_dr_river |>
#    mutate(draining_river = case_when(
#      draining_river == '100' ~ "Fraser River",
#      draining_river == '300' ~ "Columbia River",
#      T ~ draining_river
#    )) |>
#    sf::st_drop_geometry() |>
#    knitr::kable()
 
 
```


```{r}
### Table of species by waterbody
# sara_by_wb |>
#    mutate(River = case_when(
#      draining_river == '100' ~ "Fraser River",
#      draining_river == '300' ~ "Columbia River",
#      T ~ draining_river
#    )) |>
#    sf::st_drop_geometry() |>
#    knitr::kable()
```


