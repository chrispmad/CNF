---
title: "Watershed-scale Analysis of SAR and High-Priority Waterbodies"
author: "Chris Madsen and John Phelan"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(sf)
library(viridis)
library(bcdata)
library(bcmaps)
library(raster)
library(geodata)
library(dismo)
```

# This is a BIG TITLE.

## Datasets

```{r reading_in_data}
# Zebra Quagga Prioritization Model
zqpm <-read_sf("./data/Waterbodies_with_binned_and_original_values.gpkg")

# Watersheds of some scale
if(!file.exists('data/watershed_groups.gpkg')){
  ws = bcdc_query_geodata('freshwater-atlas-watershed-groups') %>%   
    # This one has 246 rows
    collect()
  sf::write_sf(ws,'data/watershed_groups.gpkg')} else {
    ws = sf::read_sf('data/watershed_groups.gpkg')
  }

# Regions (just in case)
regs = bcmaps::nr_regions()

# species-at-risk
sara = read_sf("data/dfo_sara_in_col_fras_priority_area.gpkg")

#tmax<-getData('CMIP6', var='tmax', res=10, rcp=85, model='AC', year=70)
bioclim<-worldclim_global(var="bio", res=10, path = "./data") # gets all variables
plot(bioclim)# have a look
names(bioclim)# whats the name?

#https://www.worldclim.org/data/bioclim.html
renames<-c("Annual Mean Temperature", "Mean Diurnal Range (temp)", "Isothermality", "Temperature Seasonality", "Max Temperature of Warmest Month", "Min Temperature of Coldest Month", "Temperature Annual Range", "Mean Temperature of Wettest Quarter","Mean Temperature of Driest Quarter", "Mean Temperature of Warmest Quarter", "Mean Temperature of Coldest Quarter", "Annual Precipitation", "Precipitation of Wettest Month", "Precipitation of Driest Month", "Precipitation Seasonality", "Precipitation of Wettest Quarter", "Precipitation of Driest Quarter", "Precipitation of Warmest Quarter", "Precipitation of Coldest Quarter")
renames<-gsub(" ", "_", renames)

#https://www.carbonbrief.org/cmip6-the-next-generation-of-climate-models-explained/
#https://search.r-project.org/CRAN/refmans/geodata/html/cmip6.html
cmidata<-cmip6_world("ACCESS-CM2", ssp = "585", var = "bioc", res = 5, time = "2021-2040",path="./data/CMI/")
names(cmidata)<-renames


bc<-bc_bound()
crs(bc)
bbox <- st_bbox(bc) %>% st_as_sfc() %>% st_transform(crs = 4326)
bbox

bbox_coords <- st_bbox(bbox)
extent_bbox <- extent(bbox_coords[c("xmin", "xmax", "ymin", "ymax")])
cmidata_cropped <- crop(cmidata, extent_bbox)
plot(cmidata_cropped$Annual_Mean_Temperature)

plot(st_geometry(ws))

ggplot()+
  geom_sf(data=ws)

coordinates <- xyFromCell(cmidata_cropped, cell = 1:ncell(cmidata_cropped))
temperature_values <- values(cmidata_cropped)
df <- data.frame(x = coordinates[,1], y = coordinates[,2], z = temperature_values)
ggplot(df, aes(x = x, y = y, fill = z.Annual_Mean_Temperature)) +
  geom_raster()

xmin <- -125;xmax <- -115;ymin <- 48;ymax <- 52


p1<-ggplot() +
  geom_sf(data = st_transform(ws, crs=4326)) +
  geom_raster(data = df, aes(x = x, y = y, fill = z.Annual_Mean_Temperature), alpha = 0.5)
p1
p2<-p1+coord_sf(xlim = c(xmin, xmax), ylim = c(ymin, ymax))
ggsave("./images/climate.png", width = 10, height = 8, dpi = 300)
```

```{r}
data1 |> 
  sf::st_drop_geometry() |> 
  ggplot() + 
  geom_histogram(aes(TotalInspections))
```

```{r}
head(data1)

summary(data1$TotalInspections)

data_sub<-data1[data1$TotalInspections >= 1000,]

plot1<-ggplot()+
  geom_sf(data = data_sub, aes(fill = TotalInspections)) +
  plot1+scale_fill_viridis_c(option = "plasma")

plot1
```

