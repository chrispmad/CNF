---
title: "Watershed-scale Analysis of SAR and High-Priority Waterbodies"
author: "Chris Madsen and John Phelan"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(sf)
library(viridis)
library(bcdata)
library(bcmaps)
library(raster)
library(geodata)
library(dismo)
library(ggpattern)
```

# This is a BIG TITLE.

## Datasets

```{r reading_in_data}
# Zebra Quagga Prioritization Model
zqpm <-read_sf("./data/Waterbodies_with_binned_and_original_values.gpkg")

# Watersheds of some scale
if(!file.exists('data/watershed_groups.gpkg')){
  ws = bcdc_query_geodata('freshwater-atlas-watershed-groups') %>%   
    # This one has 246 rows
    collect()
  sf::write_sf(ws,'data/watershed_groups.gpkg')} else {
    ws = sf::read_sf('data/watershed_groups.gpkg')
  }

# Regions (just in case)
regs = bcmaps::nr_regions()

# species-at-risk
sara = read_sf("data/dfo_sara_in_col_fras_priority_area.gpkg")

sciName<-unique(sara$Scientific_Name)
# Get the provincial Species-at-risk layer in the Data Catalogue.


tax_class<-c("Lampreys", "ray-finned fishes", "bivalves")

spp<-bcdc_query_geodata("species-and-ecosystems-at-risk-publicly-available-occurrences-cdc") %>% 
  filter(TAX_CLASS %in% tax_class) %>% 
  collect()

counting<- spp %>% count(spp$ENG_NAME)
counting


```

```{r}
#sub water shed scale ws 
#subset the waterbodies zqpm
# slice the first 20
# find which subwatershed these are in
# count of the sensitive species

zqpm %>% 
  mutate(across(c("Marinas","TotalInspections","Sum.of.days.fished"),
                \(x) as.numeric(cut(x,3)))) %>% 
  dplyr::select(Marinas,TotalInspections,Sum.of.days.fished)

# zqpm %>%  mutate(Marinas_B = as.numeric(cut(Marinas, 3))) %>% 
#   dplyr::select(Marinas, Marinas_B)
# zqpm$Marinas_B <- zqpm %>% mutate(Marinas_B = as.numeric(cut(Marinas, 3))) %>% 
#   dplyr::select(Marinas, Marinas_B)

# zqpm %>%  mutate(Sum.of.days.fished_B = as.numeric(cut(Sum.of.days.fished, 3))) %>% 
#   dplyr::select(sum.days.fished, sum.days.fished_B)

zqpmUseFilt<-zqpm %>% arrange(desc(Use)) %>% 
  dplyr::select(WATERSH, WATERBO, GNIS_NA, Use) %>% 
  filter(!GNIS_NA %in% c("Dry Storage", "Pacific Ocean")) %>% 
  filter(Use == 3)

ws_Use<-st_filter(ws, zqpmUseFilt)

# We can first identify which subwatershed each SAR polygons is in;
# some will be in multiple subwatersheds. A problem? Maybe.
ws = st_simplify(ws)

spp_by_ws = spp %>%
  st_join(ws %>% dplyr::select(WATERSHED_GROUP_NAME)) %>% 
  sf::st_drop_geometry() %>% 
  # dplyr::group_by(ENG_NAME) %>% 
  # dplyr::summarise(WATERSHED_GROUP_NAME = paste0(WATERSHED_GROUP_NAME, collapse = ', '))
  dplyr::select(ENG_NAME,WATERSHED_GROUP_NAME)

spp_by_ws = spp_by_ws %>% 
  dplyr::distinct() %>% 
  dplyr::count(WATERSHED_GROUP_NAME, name = 'number_distinct_SAR')

ws = ws %>% 
  dplyr::left_join(spp_by_ws)



bc<-bc_bound()

```

```{r high_use_waterbodies_by_Subwatershed}
ggplot()+
  geom_sf(data = ws, fill = "lightgrey")+ # simplify geom?
  geom_sf(data=ws_Use, fill = "orange", color = "black")+
  geom_sf(data=zqpmUseFilt, fill = "red", color="red")
```

```{r number_of_distinct_SAR_species_by_Subwatershed}
ggplot() + 
  geom_sf(data = ws, aes(fill = number_distinct_SAR)) + 
  scale_fill_fermenter(palette = 'Dark2') + 
  labs(title = 'Number of Distinct SAR by Subwatershed')
```

```{r everything_by_Subwatershed}
#define the color palette
ggplot()+
  geom_sf(data = bc, fill = "lightgrey", color = "darkgrey", alpha = 0.5)+ 
  geom_sf(data = ws[!is.na(ws$number_distinct_SAR) | ws$WATERSHED_GROUP_NAME %in% ws_Use$WATERSHED_GROUP_NAME,], aes(fill = as.factor(number_distinct_SAR))) +
  scale_fill_brewer(palette = 'Greens', na.value = 'grey') +
  geom_sf(data= zqpmUseFilt, fill = "red", color="dark red") +
  geom_sf(data= ws_Use, fill = "transparent", color = "dark blue", linewidth = 1) + 
  labs(title = "Number of Distict SAR Species and High-use Subwatersheds",
       subtitle = "High use-Subwaterhsed outlined in blue. High use waterbodies in red",
       fill = "Number of species at risk") +
  ggthemes::theme_map()+
  theme(legend.title = element_text(size = rel(1.8)))
  
```

