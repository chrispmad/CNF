---
title: "Watershed-scale Analysis of SAR and High-Priority Waterbodies"
author: "Chris Madsen and John Phelan"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
  pdf_document: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.width = 10, fig.height = 8)
library(tidyverse)
library(sf) # shapes
library(viridis) # colors
library(bcdata)
library(bcmaps)
library(raster)
library(geodata)
library(dismo) # getting the climate models and other cool things
library(ggpattern) # hatching ggplot
library(RColorBrewer) # colors
library(ggspatial) # scale bar
```

# Priority of Waterbodies Established via the ZQ Mussel Prioritization Model.

## Figures {.tabset}

```{r reading_in_data}
# Zebra Quagga Prioritization Model
zqpm <-read_sf("./data/Waterbodies_with_binned_and_original_values.gpkg")

# Watersheds of some scale
if(!file.exists('data/watershed_groups.gpkg')){
  ws = bcdc_query_geodata('freshwater-atlas-watershed-groups') %>%   
    # This one has 246 rows
    collect()
  # Simplify the geometry! Woo
  ws_s = rmapshaper::ms_simplify(ws)
  sf::write_sf(ws_s,'data/watershed_groups.gpkg')
} else {
  ws = sf::read_sf('data/watershed_groups.gpkg')
}

# Regions (just in case)
regs = bcmaps::nr_regions()

# species-at-risk
sara = read_sf("data/dfo_sara_in_col_fras_priority_area.gpkg")

sciName<-unique(sara$Scientific_Name)
# Get the provincial Species-at-risk layer in the Data Catalogue.

tax_class<-c("Lampreys", "ray-finned fishes", "bivalves")

if(!file.exists("data/SAR_occurances.gpkg")){
spp<-bcdc_query_geodata("species-and-ecosystems-at-risk-publicly-available-occurrences-cdc") %>% 
  filter(TAX_CLASS %in% tax_class) %>% 
  collect()
  sf::write_sf(spp,'data/SAR_occurances.gpkg')
}else{
  spp<-read_sf("data/SAR_occurances.gpkg")
}




counting<- spp %>% 
  sf::st_drop_geometry() %>%  
  count(spp$ENG_NAME)

#knitr::kable
```

```{r}
#sub water shed scale ws 
#subset the waterbodies zqpm
# slice the first 20
# find which subwatershed these are in
# count of the sensitive species

# zqpm %>% 
#   mutate(across(c("Marinas","TotalInspections","Sum.of.days.fished"),
#                 \(x) as.numeric(cut(x,3)))) %>% 
#   dplyr::select(Marinas,TotalInspections,Sum.of.days.fished)

# zqpm %>%  mutate(Marinas_B = as.numeric(cut(Marinas, 3))) %>% 
#   dplyr::select(Marinas, Marinas_B)
# zqpm$Marinas_B <- zqpm %>% mutate(Marinas_B = as.numeric(cut(Marinas, 3))) %>% 
#   dplyr::select(Marinas, Marinas_B)

# zqpm %>%  mutate(Sum.of.days.fished_B = as.numeric(cut(Sum.of.days.fished, 3))) %>% 
#   dplyr::select(sum.days.fished, sum.days.fished_B)

zqpmUseFilt<-zqpm %>% arrange(desc(Use)) %>% 
  dplyr::select(WATERSH, WATERBO, GNIS_NA, Use) %>% 
  filter(!GNIS_NA %in% c("Dry Storage", "Pacific Ocean")) %>% 
  filter(Use == 3)

ws_Use<-st_filter(ws, zqpmUseFilt)

# We can first identify which subwatershed each SAR polygons is in;
# some will be in multiple subwatersheds. A problem? Maybe.
ws = st_simplify(ws)

spp_by_ws = spp %>%
  st_join(ws %>% dplyr::select(WATERSHED_GROUP_NAME)) %>% 
  sf::st_drop_geometry() %>% 
  # dplyr::group_by(ENG_NAME) %>% 
  # dplyr::summarise(WATERSHED_GROUP_NAME = paste0(WATERSHED_GROUP_NAME, collapse = ', '))
  dplyr::select(ENG_NAME,WATERSHED_GROUP_NAME)

spp_by_ws = spp_by_ws %>% 
  dplyr::distinct() %>% 
  dplyr::count(WATERSHED_GROUP_NAME, name = 'number_distinct_SAR')

ws = ws %>% 
  dplyr::left_join(spp_by_ws)

#plot(st_geometry(use_Spp_Overlap))

#use_Spp_Overlap_NA<-use_Spp_Overlap[!is.na(use_Spp_Overlap$number_distinct_SAR),]
#plot(st_geometry(use_Spp_Overlap_NA))

#streams - get some SAR and crosschecck with Use
ws_Sar<-ws[!is.na(ws$number_distinct_SAR),]
ws_Sar<-ws_Sar[ws_Sar$WATERSHED_GROUP_NAME %in% ws_Use$WATERSHED_GROUP_NAME,]

#get overlap for rivers with sar 
zqpm_Overlap<-zqpmUseFilt[zqpmUseFilt$WATERSH %in% 
                            ws_Sar$WATERSHED_GROUP_ID,]
#used watersheds and sar
ws_Use_Overlap<-ws_Use[ws_Use$WATERSHED_GROUP_ID %in% 
                         ws_Sar$WATERSHED_GROUP_ID,]




bc<-bc_bound()

```

### High-use Waterbodies from ZQM Model
```{r high_use_waterbodies_by_Subwatershed}
ggplot()+
  geom_sf(data = ws, fill = "lightgrey")+ # simplify geom?
  geom_sf(data=ws_Use, fill = "purple", color = "black", alpha = 0.3)+
  geom_sf(data=zqpmUseFilt, fill = "red", color="dark red")+
  labs(title = "High use waterbodies by watershed",
       subtitle = paste0("Total number is ",nrow(ws_Use)))+
  ggthemes::theme_map()+
    theme(plot.title = element_text(size = rel(3), face = "bold"),
        plot.subtitle = element_text(size = rel(2)),
        legend.title = element_text(size = rel(1.8)),
        legend.text = element_text(size = rel(1.2))
    )
```

### Number of Distinct SAR sp.
```{r number_of_distinct_SAR_species_by_Subwatershed}
sp_colors<-c( "#EFFDB1ff","#BDD793ff","#8BB174ff","#598B56ff","#276537ff")
ggplot() + 
  geom_sf(data = ws, aes(fill = as.factor(number_distinct_SAR))) + 
  scale_fill_manual(values =  sp_colors, na.value = "grey")+
  labs(title = 'Number of Distinct SAR by Subwatershed',
       fill = "No. species at risk")+
  ggthemes::theme_map()+
  theme(plot.title = element_text(size = rel(3), face = "bold"),
        plot.subtitle = element_text(size = rel(2)),
        legend.title = element_text(size = rel(1.8)),
        legend.text = element_text(size = rel(1.2))
        )
```

### Complete Figure
```{r everything_by_Subwatershed}
#define the color palette
sp_colors<-c( "#EFFDB1ff","#BDD793ff","#8BB174ff","#598B56ff","#276537ff")

ggplot()+
  geom_sf(data = bc, fill = "lightgrey", color = "darkgrey", alpha = 0.5)+ 
  geom_sf(data = ws[!is.na(ws$number_distinct_SAR) | ws$WATERSHED_GROUP_NAME %in% ws_Use$WATERSHED_GROUP_NAME,], aes(fill = as.factor(number_distinct_SAR))) +
  scale_fill_manual(values =  sp_colors, na.value = "grey")+
  geom_sf(data= zqpmUseFilt, fill = "red", color="dark red") +
  geom_sf(data= ws_Use, fill = "transparent", color = "purple", linewidth = 0.8) + 
  labs(title = "Number of Distict SAR Species and High use sub-watersheds",
       subtitle = "High use sub-watershed outlined in purple. High use waterbodies in red",
       fill = "No. species at risk") +
  annotation_scale(location = "br", width_hint = 0.5) +
  ggthemes::theme_map()+
  theme(plot.title = element_text(size = rel(3), face = "bold"),
        plot.subtitle = element_text(size = rel(2)),
        legend.title = element_text(size = rel(1.8)),
        legend.text = element_text(size = rel(1.2))
        )
  
```

### Complete by overlap
```{r}
ggplot()+
  geom_sf(data = bc, fill = "lightgrey", color = "darkgrey", alpha = 0.5)+ 
  geom_sf(data = ws_Sar, aes(fill = as.factor(number_distinct_SAR))) +
  scale_fill_manual(values =  sp_colors, na.value = "grey")+
  geom_sf(data= zqpm_Overlap, fill = "red", color="dark red") +
  geom_sf(data= ws_Use_Overlap, fill = "transparent", color = "purple", linewidth = 0.8) + 
  labs(title = "Number of Distict SAR Species and High use sub-watersheds",
       subtitle = "High use sub-watershed outlined in purple. High use waterbodies in red",
       fill = "No. species at risk") +
  annotation_scale(location = "br", width_hint = 0.5) +
  ggthemes::theme_map()+
  theme(plot.title = element_text(size = rel(2), face = "bold"),
        plot.subtitle = element_text(size = rel(1.8)),
        legend.title = element_text(size = rel(1.3)),
        legend.text = element_text(size = rel(1.1))
        )

```

