---
title: "Watershed-scale Analysis of SAR and High-Priority Waterbodies"
author: "Chris Madsen and John Phelan"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
  pdf_document: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.width = 10, fig.height = 8)
library(tidyverse)
library(sf) # shapes
library(viridis) # colors
library(bcdata)
library(bcmaps)
library(raster)
library(geodata)
library(dismo) # getting the climate models and other cool things
library(ggpattern) # hatching ggplot
library(RColorBrewer) # colors
library(ggspatial) # scale bar
library(patchwork) # For combining ggplot figures in cool ways

path_to_user = str_extract(getwd(), ".*Users/[A-Z]+")
onedrive_path = paste0(path_to_user,"/OneDrive - Government of BC/data/CNF/")
```

# Priority of Waterbodies Established via the ZQ Mussel Prioritization Model.

## Figures {.tabset}

```{r reading_in_data}
zqpm <-read_sf(paste0(onedrive_path,"Waterbodies_with_binned_and_original_values.gpkg"))

# Watersheds of some scale
if(!file.exists(paste0(onedrive_path,'watershed_groups.gpkg'))){
  ws = bcdc_query_geodata('freshwater-atlas-watershed-groups') %>%   
    # This one has 246 rows
    collect()
  # Simplify the geometry! Woo
  ws_s = rmapshaper::ms_simplify(ws)
  sf::write_sf(ws_s,paste0(onedrive_path,'watershed_groups.gpkg'))
} else {
  ws = sf::read_sf(paste0(onedrive_path,'watershed_groups.gpkg'))
}

# Regions (just in case)
regs = bcmaps::nr_regions()

# DFO SARA spatial data.
sara = read_sf(paste0(onedrive_path,"DFO_SARA_occ_data_QGIS_simplified.gpkg"))

# sciName<-unique(sara$Scientific_Name)
# 
# tax_class<-c("Lampreys", "ray-finned fishes", "bivalves")

# if(!file.exists(paste0(onedrive_path,"SAR_occurences.gpkg"))){
#   spp<-bcdc_query_geodata("species-and-ecosystems-at-risk-publicly-available-occurrences-cdc") %>% 
#     filter(TAX_CLASS %in% tax_class) %>% 
#     collect()
#   sf::write_sf(spp,paste0(onedrive_path,'SAR_occurences.gpkg'))
# }else{
#   spp<-read_sf(paste0(onedrive_path,"SAR_occurences.gpkg"))
# }
```

```{r filter_destination_waterbodies_and_find_downstream_networks_for_each}
zqpmUseFilt<-zqpm %>% arrange(desc(InvasionRisk)) %>% 
  dplyr::select(WATERSH, WATERBO, GNIS_NA, InvasionRisk) %>% 
  filter(!GNIS_NA %in% c("Dry Storage", "Pacific Ocean")) %>% 
  filter(InvasionRisk >= 3)

ws_high_priority<-st_filter(ws, zqpmUseFilt)

# We can first identify which subwatershed each SAR polygons is in;
# some will be in multiple subwatersheds. A problem? Maybe.
ws = st_simplify(ws)
```

```{r find_downstream_geometries_for_waterbodies}
downstream_courses_b = source("scripts/find_downstream_pieces_of_waterbodies.R", local = T)$value

# I see that some waterbodies actually are missing
```

```{r assign_network_ID_to_priority_wb}
# Assign network ID to each priority wb.
downstream_courses_b = downstream_courses_b |> 
  dplyr::mutate(network_id = case_when(
    source_priority_wb == 'Shuswap Lake' ~ 1,
    source_priority_wb == 'Flathead River' ~ 2,
    source_priority_wb == 'Moyie Lake' ~ 3,
    source_priority_wb %in% c("Kalamalka Lake, Okanagan Lake",
                              "Skaha Lake","Osoyoos Lake") ~ 4,
    T ~ 5
  ))
```

```{r}
# Subtract the geometries of all the shorter downstream subsets of each downstream geometry if they are present in another waterbodies downstream, e.g. remove Columbia river for all others that code for Columbia River.

downstream_sum_tbl = downstream_courses_b |> 
  sf::st_drop_geometry() |> 
  dplyr::select(network_id, source_priority_wb,FWA_WATERSHED_CODE) |> 
  dplyr::distinct() |> 
  dplyr::add_count(source_priority_wb) |> 
  # mutate(FWA_WATERSHED_CODE = str_remove_all(FWA_WATERSHED_CODE, '-000000')) |> 
  dplyr::group_by(network_id, source_priority_wb, n) |> 
  # dplyr::summarise(list_of_fwa = paste0(FWA_WATERSHED_CODE, collapse = ',')) |> 
  ungroup() |> 
  arrange(network_id, n, str_count(FWA_WATERSHED_CODE))

downstream_courses_trimmed = downstream_courses_b


# This is the bit where we trim away the geometries of other waterbodies/their downstream bits
for(i in 1:length(unique(downstream_sum_tbl$source_priority_wb))){
  print(i)
  this_wb_name = unique(downstream_sum_tbl$source_priority_wb)[i]
  these_fwa_codes = downstream_sum_tbl[downstream_sum_tbl$source_priority_wb == this_wb_name,]$FWA_WATERSHED_CODE
  this_network = unique(downstream_sum_tbl[downstream_sum_tbl$source_priority_wb == this_wb_name,]$network_id)
  number_stream_links = unique(downstream_sum_tbl[downstream_sum_tbl$source_priority_wb == this_wb_name,]$n)
  number_of_wbs_in_network = length(unique(downstream_sum_tbl[downstream_sum_tbl$network_id == this_network,]$source_priority_wb))
  
  if(number_of_wbs_in_network == 1) next # Just one lake in this network, so nothing to trim away.
  if(number_stream_links == 1) next # Just one stream link - this is a major draining river, nothing to trim away.
  
  # This is just the members of the network with the same or more stream junctions.
  fwa_codes_of_other_network_members = downstream_sum_tbl |> 
    dplyr::filter(source_priority_wb != this_wb_name) |> 
    dplyr::filter(network_id == this_network) |> 
    dplyr::filter(n >= number_stream_links) |>
    dplyr::select(FWA_WATERSHED_CODE) |> 
    dplyr::distinct() |> 
    dplyr::pull(FWA_WATERSHED_CODE)
  
  # Filter these FWA codes out from this wb's downstream list of FWA codes.
  new_list_of_fwa_codes = these_fwa_codes[!these_fwa_codes %in% unique(fwa_codes_of_other_network_members)]
  
  # Did we lose all FWA codes? If so, restore them! This means we have two waterbodies that are virtually
  # touching and we'll not trim their downstreams.
  if(length(new_list_of_fwa_codes) == 0) new_list_of_fwa_codes = these_fwa_codes
  
  list_of_dropped_fwa_codes = these_fwa_codes[!these_fwa_codes %in% new_list_of_fwa_codes]
  
  # Add those zeros back on...
  if(length(list_of_dropped_fwa_codes) > 0){
    downstream_courses_trimmed = downstream_courses_trimmed |> 
      dplyr::filter(!(source_priority_wb == this_wb_name & FWA_WATERSHED_CODE %in% list_of_dropped_fwa_codes))
  }
}

ds_by_wb_trimmed = downstream_courses_trimmed |> 
  dplyr::group_by(source_priority_wb) |> 
  dplyr::summarise()

ggplot() + geom_sf(data = ds_by_wb_trimmed,
                   aes(col = as.character(source_priority_wb))) #+ 
  # geom_sf(data = zqpmUseFilt |> 
  #           rename(source_priority_wb = GNIS_NA), col = 'red', fill = 'red') + 
  # geom_sf_label(data = zqpmUseFilt |> 
  #                 rename(source_priority_wb = GNIS_NA),
  #               aes(label = source_priority_wb))
```

```{r visualize_waterbodies_and_their_downstreams}
ggplot() + 
  geom_sf(data = downstream_courses_b, 
          aes(col = source_priority_wb)) + 
  geom_sf(data = zqpmUseFilt, col = 'red') +
  ggrepel::geom_label_repel(data = zqpmUseFilt, 
                            aes(label = GNIS_NA, 
                                geometry = geom),
    stat = "sf_coordinates",
    min.segment.length = 0) +
  theme(legend.position = 'none')
```

```{r merge_downstream_courses_by_source_waterbody_name}
# ds_by_wb = downstream_courses_b |> 
#   dplyr::group_by(source_priority_wb, 
#                   upstream_waterbodies,
#                   network_id) |> 
#   dplyr::summarise() |> 
#   dplyr::ungroup()
# 
# ggplot() + geom_sf(data = ds_by_wb, aes(col = as.character(network_id))) + 
#   geom_sf(data = zqpmUseFilt |> 
#             rename(source_priority_wb = GNIS_NA), col = 'red', fill = 'red') + 
#   geom_sf_label(data = zqpmUseFilt |> 
#                   rename(source_priority_wb = GNIS_NA),
#                 aes(label = source_priority_wb))
  # facet_wrap(~ source_priority_wb)
# Looks good I think!
```

```{r}
# Find all subwatersheds that overlap with any of these downstream networks.
ws_high_priority = ws %>% 
  sf::st_filter(ds_by_wb)
# Might not need this anymore?
```

```{r}
# Add row identifier to each SARA record.
# sara = sara |> 
#   mutate(row_id = row_number())
```


```{r count_SARA_by_waterbodies_and_downstream_networks}
# By Waterbodies
sara_by_wb = sara %>%
  st_transform(3005) %>%
  st_join(zqpmUseFilt) %>%
  sf::st_drop_geometry() %>%
  # dplyr::group_by(ENG_NAME) %>%
  # dplyr::summarise(WATERSHED_GROUP_NAME = paste0(WATERSHED_GROUP_NAME, collapse = ', '))
  dplyr::select(Common_Name_EN,WATERSH,WATERBO,GNIS_NA)

sara_by_wb = sara_by_wb %>%
  dplyr::distinct() %>%
  dplyr::filter(!is.na(WATERSH)) |> 
  dplyr::count(GNIS_NA, name = 'number_distinct_SAR_in_waterbody')

# By Downstream network
sara_by_ds = sara %>%
  st_transform(3005) %>%
  st_join(ds_by_wb_trimmed) %>%
  sf::st_drop_geometry() %>%
  dplyr::select(Common_Name_EN,source_priority_wb)#|> 
  # dplyr::distinct()

sara_by_ds = sara_by_ds %>%
  dplyr::distinct() %>%
  dplyr::filter(!is.na(source_priority_wb)) |> 
  dplyr::count(source_priority_wb, name = 'number_distinct_SAR_downstream')

sara_summary = full_join(
  sara_by_wb |> rename(waterbody_name = GNIS_NA),
  sara_by_ds |> rename(waterbody_name = source_priority_wb)
)

# Hand-correct the Columbia River record... although only a piece of the 
# river was originally selected by IMDP records, it should be the whole thing,
# I think.
sara_summary[1,2] <- sara_summary[1,3]
sara_summary[1,3] <- NA

sara_summary = sara_summary |> 
  mutate(number_distinct_SAR_in_waterbody = replace_na(number_distinct_SAR_in_waterbody,0)) |> 
  mutate(number_distinct_SAR_downstream = number_distinct_SAR_downstream - number_distinct_SAR_in_waterbody)

# Join back onto zqpm waterbodies and ds_by_wb_trimmed

zqpmUseFilt = zqpmUseFilt |> 
  dplyr::left_join(sara_summary |> 
                     dplyr::select(GNIS_NA = waterbody_name,
                            number_distinct_SAR_in_waterbody))

ds_by_wb_trimmed = ds_by_wb_trimmed |> 
  dplyr::left_join(sara_summary |> 
                     dplyr::select(source_priority_wb = waterbody_name,
                                   number_distinct_SAR_downstream))

# # Alternate technique - overlap with split pieces of downstream networks,
# # then only retain unique matches (so that each SARA occurrence overlap can be 
# # attributed to a particular waterbody's downstream part.)
# 
# 
# all_overlaps = sara_with_id %>%
#   st_transform(3005) %>%
#   st_join(downstream_geometries_b) %>%
#   sf::st_drop_geometry() %>%
#   dplyr::select(row_id,Common_Name_EN,source_priority_wb)
# 
# # Take all overlaps and, for each unique SARA data row, find all the waterbody
# # networks it can be found overlapping with. 
# all_overlaps |> 
#   sf::st_drop_geometry() |> 
#   dplyr::distinct() |> 
#   dplyr::count(Common_Name_EN,source_priority_wb) |> 
#   dplyr::filter(!is.na(source_priority_wb))
#   summarise(source_priority_wb = paste0(source_priority_wb, collapse = ', '))
# 
# # And add our summaries back to our sf objects to enable nice plots.
# zqpmUseFilt = zqpmUseFilt |> 
#   dplyr::left_join(
#     sara_summary |> 
#       dplyr::select(GNIS_NA = waterbody_name,
#                     number_distinct_SAR = number_distinct_SAR_in_waterbody)
#   )
# 
# ds_by_wb = ds_by_wb |> 
#   dplyr::left_join(
#     sara_summary |> 
#       dplyr::select(source_priority_wb = waterbody_name,
#                     number_distinct_SAR = number_distinct_SAR_downstream)
#   )

# Use suppressMessages just in case the bcmaps package is feeling chatty.
bc <- suppressMessages(bc_bound())
```

### Data as Table
```{r}
DT::datatable(
  sara_summary
)
```

### High-Priority Waterbodies from ZQM Model
```{r high_Priority_waterbodies_by_Subwatershed}
# Combine the waterbodies flagged as high risk by the ZQ Mussel Prioritization Model with the downstream sections we found above; this allows us to plot a single sf object to the plot below and utilize a legend to easily explain what is what.

priority_wb_and_ds = dplyr::bind_rows(
  ds_by_wb_trimmed |> 
    # dplyr::rename(geom = geom) |> 
    dplyr::mutate(type = "Downstream\nNetwork"),
  zqpmUseFilt |> 
    dplyr::mutate(type = "High-priority\nWaterbody")
) |> 
  arrange(type)

# make map insert of BC with region highlighted.
map_inset = ggplot() + 
  geom_sf(data = bc) + 
  geom_sf(data = dplyr::summarise(ds_by_wb_trimmed), col = 'red') +
  ggthemes::theme_map() + 
  theme(plot.background = element_rect(color = 'black'))

main_map = ggplot() +
  geom_sf(data = bc) +
  # geom_sf(data = ws_background, fill = "lightgrey")+ # simplify geom?
  # geom_sf(data=ws_high_priority, fill = "purple", color = "black", alpha = 0.3)+
  # geom_sf(data=ds_geom_sum, fill = "orange", color="orange")+
  # geom_sf(data=zqpmUseFilt, fill = "red", color="darkred")+
  geom_sf(data = priority_wb_and_ds, aes(fill = type, col = type)) +
  scale_fill_manual(values = c("Downstream\nNetwork" = "orange",
                               "High-priority\nWaterbody" = "red")) +
  scale_colour_manual(values = c("Downstream\nNetwork" = "orange",
                               "High-priority\nWaterbody" = "red")) +
  labs(title = "High Priority waterbodies by subwatershed",
       # subtitle = paste0("This includes downstream networks. \nTotal number of subwatersheds: ",nrow(ws_high_priority)),
       fill = "Waterbody\nType",
       colour = "Waterbody\nType")+
  ggthemes::theme_map()+
  theme(plot.title = element_text(size = rel(2), face = "bold"),
        plot.subtitle = element_text(size = rel(1.8)),
        legend.title = element_text(size = rel(1.8)),
        legend.text = element_text(size = rel(1.2)),
        legend.position = 'right'
  ) + 
  coord_sf(xlim = sf::st_bbox(ws_high_priority)[c(1,3)],
           ylim = sf::st_bbox(ws_high_priority)[c(2,4)]) + 
  ggspatial::annotation_scale()

# The following code to combine plots uses the {patchwork} package.
main_map + patchwork::inset_element(map_inset, right = 1, top = 1, left = 0.8, bottom = 0.75)
```

### Number of Distinct SAR sp.
```{r number_of_distinct_SAR_species_by_Subwatershed}
sp_colors<-c( "#EFFDB1ff","#BDD793ff","#8BB174ff","#598B56ff","#276537ff")

ggplot() + 
  # geom_sf(data = ds_by_wb, aes(col = number_distinct_SAR)) +
  geom_sf(data = priority_wb_and_ds |> 
            dplyr::arrange(dplyr::desc(number_distinct_SAR)), 
          aes(col = number_distinct_SAR,
              fill = number_distinct_SAR)) +
  # geom_sf(data = ws, aes(fill = as.factor(number_distinct_SAR))) + 
  # scale_fill_manual(values = sp_colors, na.value = "grey")+
  # scale_fill_manual(values = sp_colors, na.value = "grey")+
  scale_color_viridis_c() +
  scale_fill_viridis_c() +
  labs(title = 'Number of Distinct SARA-listed Species by Waterbody / Downstream',
       fill = "No. species at risk",
       col = 'No. species at risk')+
  ggthemes::theme_map()+
  theme(plot.title = element_text(size = rel(3), face = "bold"),
        plot.subtitle = element_text(size = rel(2)),
        legend.title = element_text(size = rel(1.8)),
        legend.text = element_text(size = rel(1.2))
  )

## I'VE EDITED UP TO HERE ##
```

### All Data
```{r all_data}
#define the color palette
sp_colors<-c( "#EFFDB1ff","#BDD793ff","#8BB174ff","#598B56ff","#276537ff")

# Combine high-priority waterbodies, downstream networks, and subwatersheds with counts of distinct SARA-listed species into one sf object (then we can use the fill for three different datsets!)

# sf_dat_for_plot = dplyr::bind_rows(
#   ws |> 
#     dplyr::filter(!is.na(number_distinct_SAR) | WATERSHED_GROUP_NAME %in% ws_high_priority$WATERSHED_GROUP_NAME) |> 
#     mutate(type = "Number SARA-listed Species") |> 
#     dplyr::select(),
#   ds_geom_sum |> 
#     dplyr::rename(geom = geometry) |> 
#     dplyr::mutate(type = "Downstream\nNetwork"),
#   zqpmUseFilt |> 
#     dplyr::mutate(type = "High-priority\nWaterbody")
# )

ggplot()+
  geom_sf(data = bc, fill = "lightgrey", color = "darkgrey", alpha = 0.7)+ 
  geom_sf(data = ws[!is.na(ws$number_distinct_SAR) | ws$WATERSHED_GROUP_NAME %in% ws_high_priority$WATERSHED_GROUP_NAME,], aes(fill = as.factor(number_distinct_SAR))) +
  scale_fill_manual(values =  sp_colors, na.value = "grey")+
  # geom_sf(data= ds_geom_sum, fill = "red", color="dark red") +
  geom_sf(data = priority_wb_and_ds, col = 'red', fill = 'red') +
  geom_sf(data = ws_high_priority, fill = "transparent", color = "purple", linewidth = 0.8) + 
  labs(title = "Number of SARA-listed Species and High Priority Subwatersheds",
       subtitle = "High priority subwatersheds outlined in purple\nHigh priority waterbodies and downstream Networks in red",
       fill = "No. species at risk") +
  annotation_scale(location = "br", width_hint = 0.5) +
  ggthemes::theme_map()+
  theme(plot.title = element_text(size = rel(1.8), face = "bold"),
        plot.subtitle = element_text(size = rel(1.6)),
        legend.title = element_text(size = rel(1.3)),
        legend.text = element_text(size = rel(1.1))
        )
  
```

### Only Overlapping Data
```{r}
ggplot()+
  geom_sf(data = bc, fill = "lightgrey", color = "darkgrey", alpha = 0.7)+ 
  geom_sf(data = ws_Sar, aes(fill = as.factor(number_distinct_SAR))) +
  scale_fill_manual(values =  sp_colors, na.value = "grey")+
  geom_sf(data= zqpm_Overlap, fill = "red", color="dark red") +
  geom_sf(data= ws_high_priority_Overlap, fill = "transparent", color = "purple", linewidth = 0.8) + 
  labs(title = "Number of SARA-listed Species and High Priority Subwatersheds",
       subtitle = "High priority subwatersheds outlined in purple \nHigh priority waterbodies and downstream network in red",
       fill = "No. species at risk") +
  annotation_scale(location = "br", width_hint = 0.5) +
  ggthemes::theme_map()+
  theme(plot.title = element_text(size = rel(1.8), face = "bold"),
        plot.subtitle = element_text(size = rel(1.6)),
        legend.title = element_text(size = rel(1.3)),
        legend.text = element_text(size = rel(1.1))
        )

```

### Cropped and road Network
```{r Road_Network_Plot}

roadNetwork<-bcdc_query_geodata("digital-road-atlas-dra-master-partially-attributed-roads") %>% 
  filter(BBOX(local(st_bbox(ws_high_priority_Overlap, crs = st_crs(ws_high_priority_Overlap))))) %>% 
  filter(!is.na(HIGHWAY_ROUTE_NUMBER)) %>% 
  collect()

ggplot()+
  geom_sf(data = st_crop(bc, ws_high_priority_Overlap), fill = "lightgrey", color = "darkgrey", alpha = 0.7)+
  geom_sf(data = ws_Sar, aes(fill = as.factor(number_distinct_SAR))) +
  scale_fill_manual(values =  sp_colors, na.value = "grey")+
  geom_sf(data= zqpm_Overlap, fill = "red", color="dark red") +
  geom_sf(data= ws_high_priority_Overlap, fill = "transparent", color = "purple", linewidth = 0.8) +
  geom_sf(data = roadNetwork, color = "Black", linewidth = 1, alpha = 0.4)+
  labs(title = "Number of Distict SAR Species and High use sub-watersheds",
       subtitle = "High use sub-watershed outlined in purple \nHigh use waterbodies and downstream network in red \nRoad networks in black",
       fill = "No. species at risk") +
  annotation_scale(location = "br", width_hint = 0.5) +
  coord_sf(xlim = sf::st_bbox(ws_high_priority)[c(1,3)],
           ylim = sf::st_bbox(ws_high_priority)[c(2,4)]) + 
  ggthemes::theme_map()+
  theme(plot.title = element_text(size = rel(2), face = "bold"),
        plot.subtitle = element_text(size = rel(1.8)),
        legend.title = element_text(size = rel(1.3)),
        legend.text = element_text(size = rel(1.1))
        )
```



